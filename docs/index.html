<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>TrueSkill Foosball CBGP</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f5f6fa;
    padding: 40px;
}

h1, h2 {
    text-align: center;
}

table {
    border-collapse: collapse;
    margin: auto;
    background: white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

th, td {
    padding: 10px 14px;
    text-align: center;
}

th {
    background: #2f3640;
    color: white;
}

tr:nth-child(even) {
    background: #f1f1f1;
}

.top1 { background: #ffeaa7; }
.top2 { background: #dfe6e9; }
.top3 { background: #fab1a0; }

small {
    color: #636e72;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>

<body>

<h1>ğŸ† TrueSkill ranking</h1>

<table id="classement">
<thead>
<tr>
    <th>Rank</th>
    <th>Player</th>
    <th>Score</th>
    <th>Î¼</th>
    <th>Ïƒ</th>
    <th>Games</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h2 style="margin-top:50px;">ğŸ“ˆ TrueSkill score evolution</h2>

<!-- ======== CONTROLES ======== -->
<div style="width:90%;margin:auto;text-align:center;margin-bottom:20px;">
    <button onclick="setRange('week')">Last 7 days</button>
    <button onclick="setRange('year')">This year</button>
    <button onclick="setRange('all')">From the beginning</button>

    <br><br>

    From <input type="date" id="fromDate">
    To <input type="date" id="toDate">
    <button onclick="setCustomRange()">OK</button>

    <br><br>

    <button onclick="toggleXAxis()">ğŸ”„ Switch X-axis (time / match days)</button><br>
    <small>Time = calendar days â€¢ Match days = only days with games</small>
</div>

<div style="width:90%;margin:auto;">
    <canvas id="allPlayersChart"></canvas>
</div>

<script>
// =======================
// TABLEAU CLASSEMENT
// =======================
fetch("resultats/classement_actuel.csv")
.then(r => r.text())
.then(text => {
    const lines = text.trim().split("\n");
    const headers = lines[0].split(",");
    const rows = lines.slice(1).map(line => {
        const cols = line.split(",");
        let obj = {};
        headers.forEach((h,i)=>obj[h]=cols[i]);
        return obj;
    });

    const tbody = document.querySelector("#classement tbody");

    rows.forEach((row,index)=>{
        const tr = document.createElement("tr");
        if(index===0) tr.classList.add("top1");
        if(index===1) tr.classList.add("top2");
        if(index===2) tr.classList.add("top3");

        ["rang","joueur","score","mu","sigma","matches"].forEach(k=>{
            const td = document.createElement("td");
            td.textContent = isNaN(row[k]) ? row[k] : Number(row[k]).toFixed(2);
            tr.appendChild(td);
        });

        tbody.appendChild(tr);
    });
});

// =======================
// VARIABLES GLOBALES
// =======================
let chart = null;
let fullDatasets = [];
let allMatchDates = [];
let xMode = "time";

// =======================
// COULEUR UNIQUE
// =======================
function colorForIndex(i,total){
    return `hsl(${Math.round(360*i/total)},70%,45%)`;
}

// =======================
// LECTURE HISTORIQUE
// =======================
fetch("resultats/historique_classement.csv")
.then(r=>r.text())
.then(text=>{
    const lines = text.trim().split("\n");
    const headers = lines[0].split(",");
    const historique = lines.slice(1).map(line=>{
        const cols = line.split(",");
        let obj={};
        headers.forEach((h,i)=>obj[h]=cols[i]);
        return obj;
    });

    fetch("resultats/classement_actuel.csv")
    .then(r=>r.text())
    .then(t=>{
        const order = t.trim().split("\n").slice(1).map(l=>l.split(",")[1].trim());
        drawAllPlayersChart(historique, order);
    });
});

// =======================
// DESSIN DU GRAPHIQUE
// =======================
function drawAllPlayersChart(historique, classementOrder){

    const joueurs = classementOrder.filter(j =>
        historique.some(d=>d.joueur.trim()===j)
    );

    allMatchDates = [...new Set(historique.map(d=>d.date))]
        .sort((a,b)=>new Date(a)-new Date(b));

    const datasets = joueurs.map((joueur,index)=>{
        const color = colorForIndex(index,joueurs.length);
        const rows = historique.filter(d=>d.joueur.trim()===joueur);

        const lastPerDay = {};
        rows.forEach(r=>lastPerDay[r.date]=r);

        const timeData = Object.values(lastPerDay)
            .sort((a,b)=>new Date(a.date)-new Date(b.date))
            .map(d=>{
                const [y,m,day]=d.date.split("-");
                return {x:new Date(y,m-1,day,0,0,0), y:parseFloat(d.score)};
            });

        const scoreByDate = {};
        Object.values(lastPerDay).forEach(d=>scoreByDate[d.date]=parseFloat(d.score));

        const categoryData = allMatchDates.map(date=>({
            x:date,
            y:scoreByDate[date] ?? null
        }));

        return {
            label: joueur,
            borderColor: color,
            backgroundColor: color,
            borderWidth: 1.5,
            tension: 0.3,
            fill:false,
            pointRadius:3,
            pointHoverRadius:6,
            timeData,
            categoryData,
            data: timeData
        };
    });

    fullDatasets = datasets.map(ds=>({
        ...ds,
        timeData:[...ds.timeData],
        categoryData:[...ds.categoryData]
    }));

    chart = new Chart(document.getElementById("allPlayersChart"), {
        type:"line",
        data:{datasets},
        options:getChartOptions()
    });

    setRange("week");
}

// =======================
// OPTIONS DYNAMIQUES
// =======================
function getChartOptions(){
    return {
        responsive:true,
        interaction:{mode:"nearest",intersect:false},
        plugins:{
            legend:{
                position:"right",
                onHover:(e,item,l)=>{
                    l.chart.data.datasets[item.datasetIndex].borderWidth=4;
                    l.chart.update();
                },
                onLeave:(e,item,l)=>{
                    l.chart.data.datasets[item.datasetIndex].borderWidth=1.5;
                    l.chart.update();
                }
            },
            tooltip:{
                callbacks:{
                    label: ctx =>
                        `${ctx.dataset.label} : ${ctx.parsed.y.toFixed(2)}`
                }
            }
        },
        scales:{
            x: xMode==="time"
                ? {type:"time",time:{unit:"day"},title:{display:true,text:"Date"}}
                : {type:"category",labels:allMatchDates,title:{display:true,text:"Match days"}},
            y:{title:{display:true,text:"Score"}}
        }
    };
}

// =======================
// SWITCH AXE X
// =======================
function toggleXAxis(){
    xMode = xMode==="time" ? "category" : "time";
    chart.data.datasets.forEach((ds,i)=>{
        ds.data = xMode==="time"
            ? fullDatasets[i].timeData
            : fullDatasets[i].categoryData;
    });
    chart.options = getChartOptions();
    chart.update();
}

// =======================
// FILTRES TEMPORELS
// =======================
function setRange(type){
    const now = new Date();
    let start=null;
    if(type==="week"){ start=new Date(); start.setDate(now.getDate()-7); }
    else if(type==="year"){ start=new Date(now.getFullYear(),0,1); }
    applyRange(start,now);
}

function setCustomRange(){
    const f=document.getElementById("fromDate").value;
    const t=document.getElementById("toDate").value;
    if(!f||!t) return;
    applyRange(new Date(f),new Date(t));
}

function applyRange(start,end){
    chart.data.datasets.forEach((ds,i)=>{
        ds.data = fullDatasets[i][xMode+"Data"].filter(p=>{
            if(!p.y) return false;
            const d = xMode==="time" ? new Date(p.x) : new Date(p.x);
            if(start && d<start) return false;
            if(end && d>end) return false;
            return true;
        });
    });
    chart.update();
}
</script>

</body>
</html>
