<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>TrueSkill Foosball CBGP</title>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f5f6fa;
    padding: 40px;
}

h1, h2 {
    text-align: center;
}

table {
    border-collapse: collapse;
    margin: auto;
    background: white;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}

th, td {
    padding: 10px 14px;
    text-align: center;
}

th {
    background: #2f3640;
    color: white;
}

tr:nth-child(even) {
    background: #f1f1f1;
}

.top1 { background: #ffeaa7; }
.top2 { background: #dfe6e9; }
.top3 { background: #fab1a0; }

small {
    color: #636e72;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>

<body>

<h1>üèÜ TrueSkill ranking</h1>

<table id="classement">
<thead>
<tr>
    <th>Rank</th>
    <th>Player</th>
    <th>Score</th>
    <th>Œº</th>
    <th>œÉ</th>
    <th>Games</th>
</tr>
</thead>
<tbody></tbody>
</table>

<h2 style="margin-top:50px;">üìà TrueSkill score evolution</h2>

<div style="width:90%;margin:auto;text-align:center;margin-bottom:20px;">
    <button onclick="setRange('all')">From the beginning</button>
    <button onclick="setRange('year')">This year</button>
    <button onclick="setRange('week')">Last 7 days</button>

    <br><br>

    <span style="font-size:0.85em;">
        From <input type="date" id="fromDate">
        to <input type="date" id="toDate">
    </span>
    <button onclick="setCustomRange()">OK</button>

    <br><br>

    <button onclick="toggleXAxis()">üîÑ Switch X-axis (time / match days)</button><br>
    <small>Time = calendar days ‚Ä¢ Match days = only days with games</small>
</div>

<div style="width:90%;margin:auto;">
    <canvas id="allPlayersChart"></canvas>
</div>

<script>
// =======================
// CLASSEMENT
// =======================
fetch("resultats/classement_actuel.csv")
.then(r => r.text())
.then(text => {
    const lines = text.trim().split("\n");
    const headers = lines[0].split(",");
    const rows = lines.slice(1).map(l => {
        const c = l.split(",");
        let o = {};
        headers.forEach((h,i)=>o[h]=c[i]);
        return o;
    });

    const tbody = document.querySelector("#classement tbody");

    rows.forEach((row,i)=>{
        const tr = document.createElement("tr");
        if(i===0) tr.classList.add("top1");
        if(i===1) tr.classList.add("top2");
        if(i===2) tr.classList.add("top3");

        ["rang","joueur","score","mu","sigma","matches"].forEach(k=>{
            const td = document.createElement("td");
            td.textContent = isNaN(row[k]) ? row[k] : Number(row[k]).toFixed(2);
            tr.appendChild(td);
        });

        tbody.appendChild(tr);
    });
});

// =======================
// VARIABLES
// =======================
let chart = null;
let fullDatasets = [];
let allMatchDates = [];
let xMode = "category";
let currentRange = "all";

// =======================
function colorForIndex(i,total){
    return `hsl(${Math.round(360*i/total)},70%,45%)`;
}

// =======================
// HISTORIQUE
// =======================
fetch("resultats/historique_classement.csv")
.then(r=>r.text())
.then(text=>{
    const lines = text.trim().split("\n");
    const headers = lines[0].split(",");
    const historique = lines.slice(1).map(l=>{
        const c = l.split(",");
        let o = {};
        headers.forEach((h,i)=>o[h]=c[i]);
        return o;
    });

    fetch("resultats/classement_actuel.csv")
    .then(r=>r.text())
    .then(t=>{
        const order = t.trim().split("\n").slice(1).map(l=>l.split(",")[1].trim());
        drawAllPlayersChart(historique, order);
    });
});

// =======================
// GRAPHIQUE
// =======================
function drawAllPlayersChart(historique, classementOrder){

    const joueurs = classementOrder.filter(j =>
        historique.some(d=>d.joueur.trim()===j)
    );

    allMatchDates = [...new Set(historique.map(d=>d.date))].sort();

    const datasets = joueurs.map((joueur,index)=>{
        const color = colorForIndex(index,joueurs.length);
        const rows = historique.filter(d=>d.joueur.trim()===joueur);

        const lastPerDay = {};
        rows.forEach(r=>lastPerDay[r.date]=r);

        const timeData = Object.values(lastPerDay)
            .sort((a,b)=>a.date.localeCompare(b.date))
            .map(d=>{
                const [y,m,day] = d.date.split("-").map(Number);
                return {
                    x: new Date(y, m-1, day, 23, 59, 0), // ‚¨ÖÔ∏è SCORE √Ä 23:59
                    y: parseFloat(d.score)
                };
            });

        return {
            label: joueur,
            borderColor: color,
            backgroundColor: color,
            borderWidth: 1.5,
            tension: 0.3,
            fill:false,
            pointRadius:3,
            pointHoverRadius:6,
            timeData,
            data: timeData
        };
    });

    fullDatasets = datasets.map(ds=>({
        ...ds,
        timeData:[...ds.timeData]
    }));

    chart = new Chart(document.getElementById("allPlayersChart"), {
        type:"line",
        data:{datasets},
        options:getChartOptions()
    });

    setRange("all");
}

// =======================
function getChartOptions(){
    return {
        responsive:true,
        interaction:{mode:"nearest",intersect:false},
        plugins:{
            legend:{ position:"right" },
            tooltip:{
                callbacks:{
                    label: ctx =>
                        `${ctx.dataset.label} : ${ctx.parsed.y.toFixed(2)}`
                }
            }
        },
        scales:{
            x:{ type:"time", time:{unit:"day"}, title:{display:true,text:"Date"} },
            y:{ title:{display:true,text:"Score"} }
        }
    };
}

// =======================
function toggleXAxis(){
    xMode = xMode==="time" ? "category" : "time";
    setRange(currentRange);
}

// =======================
// FILTRES
// =======================
function setRange(type){
    currentRange = type;
    const now = new Date();
    let start = null;

    if(type==="week"){
        start = new Date();
        start.setDate(now.getDate()-7);
    } else if(type==="year"){
        start = new Date(now.getFullYear(),0,1);
    }

    applyRange(start, now);
}

function setCustomRange(){
    const f = document.getElementById("fromDate").value;
    const t = document.getElementById("toDate").value;
    if(!f || !t) return;

    const start = new Date(f);
    const end = new Date(t);
    end.setHours(23,59,59,999); // ‚¨ÖÔ∏è inclure toute la journ√©e

    currentRange = "custom";
    applyRange(start, end);
}

function applyRange(startDate, endDate){

    let visibleDates = [];

    chart.data.datasets.forEach((ds,i)=>{
        const filtered = fullDatasets[i].timeData.filter(p=>{
            if(startDate && p.x < startDate) return false;
            if(endDate && p.x > endDate) return false;
            return true;
        });

        filtered.forEach(p=>{
            visibleDates.push(p.x.toISOString().split("T")[0]);
        });

        if(xMode==="time"){
            ds.data = filtered;
        } else {
            const byDate = {};
            filtered.forEach(p=>{
                byDate[p.x.toISOString().split("T")[0]] = p.y;
            });

            ds.data = [...new Set(visibleDates)]
                .sort()
                .map(d=>({x:d,y:byDate[d] ?? null}));
        }
    });

    chart.options.scales.x = xMode==="time"
        ? {type:"time",time:{unit:"day"},title:{display:true,text:"Date"}}
        : {type:"category",labels:[...new Set(visibleDates)].sort(),title:{display:true,text:"Match days"}};

    chart.update();
}
</script>

</body>
</html>
